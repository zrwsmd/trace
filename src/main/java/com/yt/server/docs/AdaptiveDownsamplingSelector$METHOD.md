# AdaptiveDownsamplingSelector#peakDetectionDownsampling æ–¹æ³•è¯¦è§£

`com.yt.server.util.AdaptiveDownsamplingSelector#peakDetectionDownsampling` æ˜¯ä¸€ä¸ªåŸºäº**ç‰¹å¾é‡è¦æ€§**æ’åºçš„é™é‡‡æ ·ç®—æ³•ã€‚

å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š**ä¼˜å…ˆä¿ç•™é‚£äº›â€œå¼¯æ›²ç¨‹åº¦â€æœ€å¤§ï¼ˆå³äºŒé˜¶å¯¼æ•°ç»å¯¹å€¼æœ€å¤§ï¼‰çš„ç‚¹**ï¼Œå› ä¸ºè¿™äº›ç‚¹é€šå¸¸å¯¹åº”ç€æ³¢å³°ã€æ³¢è°·æˆ–ä¿¡å·çªå˜çš„ä½ç½®ï¼Œè€Œä¸¢å¼ƒé‚£äº›åœ¨ç›´çº¿ä¸Šæˆ–å˜åŒ–å¹³ç¼“çš„ç‚¹ã€‚

## æ ¸å¿ƒé€»è¾‘æ­¥éª¤

1. **å¼ºåˆ¶ä¿ç•™é¦–å°¾**ï¼šå°†ç¬¬ä¸€ä¸ªç‚¹å’Œæœ€åä¸€ä¸ªç‚¹çš„é‡è¦æ€§è®¾ä¸ºæœ€å¤§å€¼ï¼ˆ`Double.MAX_VALUE`ï¼‰ï¼Œç¡®ä¿å®ƒä»¬ä¸€å®šè¢«é€‰ä¸­ï¼Œç»´æŒæ•°æ®çš„æ—¶é—´è·¨åº¦ã€‚
2. **è®¡ç®—é‡è¦æ€§ï¼ˆæ›²ç‡ï¼‰**ï¼šå¯¹äºä¸­é—´çš„æ¯ä¸€ä¸ªç‚¹ï¼Œè®¡ç®—å…¶äºŒé˜¶å·®åˆ†ï¼ˆè¿‘ä¼¼äºŒé˜¶å¯¼æ•°ï¼‰ï¼š
   $$ \text{Importance} = | \text{Next}_y - 2 \times \text{Curr}_y + \text{Prev}_y | $$
    * ç‰©ç†æ„ä¹‰ï¼šè¿™ä¸ªå€¼åæ˜ äº†å½“å‰ç‚¹åç¦»ç”±å‰åä¸¤ç‚¹æ„æˆçš„ç›´çº¿çš„ç¨‹åº¦ã€‚å¦‚æœä¸‰ç‚¹å…±çº¿ï¼Œå€¼ä¸º0ï¼›å¦‚æœæ˜¯ä¸ªå°–å³°ï¼Œå€¼ä¼šå¾ˆå¤§ã€‚
3. **æ’åºä¸ç­›é€‰**ï¼šå°†æ‰€æœ‰ç‚¹æŒ‰é‡è¦æ€§ä»å¤§åˆ°å°æ’åºï¼Œé€‰å–å‰ `targetCount` ä¸ªæœ€é‡è¦çš„ç‚¹ã€‚
4. **æŒ‰åºé‡ç»„**ï¼šå°†é€‰ä¸­çš„ç‚¹æŒ‰åŸå§‹ç´¢å¼•ï¼ˆæ—¶é—´é¡ºåºï¼‰é‡æ–°æ’åºï¼Œè¾“å‡ºç»“æœã€‚

## æ ¸å¿ƒåŸç†è§£æï¼šä»€ä¹ˆæ˜¯äºŒé˜¶å¯¼æ•°ï¼ˆæ›²ç‡ï¼‰ï¼Ÿ

ç®€å•æ¥è¯´ï¼Œ**äºŒé˜¶å¯¼æ•°**æè¿°çš„æ˜¯**å˜åŒ–çš„å¿«æ…¢**ï¼Œæˆ–è€…è¯´**å¼¯æ›²çš„ç¨‹åº¦**ã€‚

åœ¨æ•°æ®å¤„ç†ä¸­ï¼Œå¦‚æœè¯´ï¼š

* **æ•°å€¼ ($y$)** = æ±½è½¦çš„ä½ç½®
* **ä¸€é˜¶å¯¼æ•° (æ–œç‡)** = æ±½è½¦çš„é€Ÿåº¦ï¼ˆå˜åŒ–çš„å¿«æ…¢ï¼‰
* **äºŒé˜¶å¯¼æ•° (æ›²ç‡)** = æ±½è½¦çš„**åŠ é€Ÿåº¦/åˆ¹è½¦**ï¼ˆé€Ÿåº¦å˜åŒ–çš„å¿«æ…¢ï¼‰

### 1. å…¬å¼è§£é‡Š

åœ¨ç¦»æ•£çš„æ•°æ®ç‚¹ä¸­ï¼ˆæ¯”å¦‚ $A, B, C$ ä¸‰ä¸ªè¿ç»­çš„ç‚¹ï¼‰ï¼ŒäºŒé˜¶å¯¼æ•°é€šå¸¸é€šè¿‡**äºŒé˜¶å·®åˆ†**æ¥è®¡ç®—ï¼š

$$ \text{äºŒé˜¶å¯¼æ•°} \approx (C - B) - (B - A) = C - 2B + A $$

* $(C - B)$ æ˜¯åä¸€æ®µçš„æ–œç‡ï¼ˆåä¸€ä¸ªå˜åŒ–è¶‹åŠ¿ï¼‰
* $(B - A)$ æ˜¯å‰ä¸€æ®µçš„æ–œç‡ï¼ˆå‰ä¸€ä¸ªå˜åŒ–è¶‹åŠ¿ï¼‰
* ä¸¤è€…çš„å·®å€¼ï¼Œå°±æ˜¯**è¶‹åŠ¿æ”¹å˜äº†å¤šå°‘**ã€‚

### 2. ç›´è§‚ä¸¾ä¾‹

å‡è®¾æˆ‘ä»¬æœ‰ä¸‰ä¸ªè¿ç»­çš„æ—¶é—´ç‚¹ï¼Œçœ‹çœ‹ä¸åŒçš„æ•°æ®å½¢æ€ä¸‹ï¼ŒäºŒé˜¶å¯¼æ•°ï¼ˆé‡è¦æ€§ï¼‰æ˜¯å¤šå°‘ï¼š

#### A. ç›´çº¿è¡Œé©¶ (å¹³ç¨³/åŒ€é€Ÿ) -> äºŒé˜¶å¯¼æ•°ä¸º 0

æ•°æ®ï¼š`10, 20, 30`

* **ç›´è§‚æ„Ÿå—**ï¼šè¿™æ˜¯ä¸€æ¡ç›´çº¿ï¼Œæ²¡æœ‰å¼¯æ›²ã€‚
* **ä¸€é˜¶å˜åŒ–**ï¼š
    * 10å˜åˆ°20ï¼Œæ¶¨äº† 10
    * 20å˜åˆ°30ï¼Œåˆæ¶¨äº† 10
    * é€Ÿåº¦æ²¡å˜ã€‚
* **äºŒé˜¶è®¡ç®—**ï¼š
  $$ |30 - 2 \times 20 + 10| = |30 - 40 + 10| = |0| $$
* **ç»“è®º**ï¼š**0**ã€‚è¿™ä¸‰ä¸ªç‚¹åœ¨ä¸€æ¡ç›´çº¿ä¸Šï¼Œä¸­é—´é‚£ä¸ªç‚¹ `20` å¹¶ä¸ç‰¹æ®Šï¼Œå¦‚æœæŠŠå®ƒåˆ äº†ï¼Œç›´æ¥è¿ `10` å’Œ `30`ï¼Œå½¢çŠ¶å‡ ä¹æ²¡å˜ã€‚æ‰€ä»¥å®ƒ**ä¸é‡è¦
  **ã€‚

#### B. ç¼“æ…¢åŠ é€Ÿ (å¹³æ»‘æ›²çº¿) -> äºŒé˜¶å¯¼æ•°å¾ˆå°

æ•°æ®ï¼š`10, 12, 16`

* **ç›´è§‚æ„Ÿå—**ï¼šå¼€å§‹æ¶¨å¾—æ…¢ï¼Œåæ¥æ¶¨å¾—å¿«ï¼Œæœ‰ä¸€ç‚¹ç‚¹å¼¯æ›²ã€‚
* **ä¸€é˜¶å˜åŒ–**ï¼š
    * 10å˜åˆ°12ï¼Œæ¶¨äº† 2
    * 12å˜åˆ°16ï¼Œæ¶¨äº† 4
    * é€Ÿåº¦å˜å¿«äº†ä¸€ç‚¹ç‚¹ã€‚
* **äºŒé˜¶è®¡ç®—**ï¼š
  $$ |16 - 2 \times 12 + 10| = |16 - 24 + 10| = |2| $$
* **ç»“è®º**ï¼š**2**ã€‚æœ‰ä¸€ç‚¹é‡è¦æ€§ï¼Œä½†ä¸å¤§ã€‚

#### C. æ€¥è½¬å¼¯/å°–å³° (å‰§çƒˆçªå˜) -> äºŒé˜¶å¯¼æ•°æå¤§ ğŸ”¥

æ•°æ®ï¼š`10, 100, 10`

* **ç›´è§‚æ„Ÿå—**ï¼šçªç„¶å†²ä¸Šå»ï¼Œåˆçªç„¶æ‰ä¸‹æ¥ã€‚è¿™æ˜¯ä¸€ä¸ªå°–å³°ï¼ˆè„‰å†²ï¼‰ã€‚
* **ä¸€é˜¶å˜åŒ–**ï¼š
    * 10å˜åˆ°100ï¼ŒçŒ›æ¶¨ 90 (é€Ÿåº¦æå¿«å‘ä¸Š)
    * 100å˜åˆ°10ï¼ŒçŒ›è·Œ 90 (é€Ÿåº¦æå¿«å‘ä¸‹)
    * æ–¹å‘å‘ç”Ÿäº† 180åº¦ å¤§é€†è½¬ï¼
* **äºŒé˜¶è®¡ç®—**ï¼š
  $$ |10 - 2 \times 100 + 10| = |20 - 200| = |-180| \Rightarrow 180 $$
* **ç»“è®º**ï¼š**180**ã€‚æ•°å€¼éå¸¸å¤§ï¼ä¸­é—´è¿™ä¸ª `100` æ˜¯æœ€å…³é”®çš„è½¬æŠ˜ç‚¹ã€‚å¦‚æœæŠŠå®ƒåˆ äº†ï¼Œç›´æ¥è¿ä¸¤å¤´çš„ `10` å’Œ `10`
  ï¼Œæ•´ä¸ªå°–å³°å°±æ¶ˆå¤±äº†ï¼Œæ•°æ®ç‰¹å¾å°±ä¸¢å¤±äº†ã€‚æ‰€ä»¥å®ƒ**æåº¦é‡è¦**ã€‚

### æ€»ç»“

`peakDetectionDownsampling` ç®—æ³•åˆ©ç”¨è¿™ä¸ªåŸç†ï¼š

* **æ•°å€¼å°**ï¼ˆæ¥è¿‘0ï¼‰ï¼šè¯´æ˜æ˜¯ç›´çº¿æˆ–å¹³æ»‘æ›²çº¿ï¼Œåˆ äº†æ— æ‰€è°“ã€‚
* **æ•°å€¼å¤§**ï¼šè¯´æ˜æ˜¯æ‹ç‚¹ã€å°–å³°ã€çªå˜ç‚¹ï¼Œå¿…é¡»ä¿ç•™ã€‚

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå®ƒèƒ½ç²¾å‡†åœ°ä¿ç•™ä¿¡å·ä¸­çš„â€œç‰¹å¾â€è€Œä¸æµªè´¹ç‚¹æ•°åœ¨å¹³ç›´çš„çº¿æ®µä¸Šã€‚

## ä¸¾ä¾‹è¯´æ˜

å‡è®¾æˆ‘ä»¬æœ‰ 5 ä¸ªæ•°æ®ç‚¹ï¼Œä»£è¡¨ä¸€ä¸ªå¹³ç¨³ä¿¡å·ä¸­é—´çªç„¶å‡ºç°ä¸€ä¸ªè„‰å†²ï¼Œæˆ‘ä»¬è¦å°†å…¶é™é‡‡æ ·ä¸º **3ä¸ªç‚¹**ã€‚

**åŸå§‹æ•°æ® (Index: Yå€¼)**ï¼š

* **Idx 0**: `10` (èµ·ç‚¹)
* **Idx 1**: `10` (å¹³ç¨³)
* **Idx 2**: `50` (**çªå˜å³°å€¼**)
* **Idx 3**: `10` (å¹³ç¨³)
* **Idx 4**: `10` (ç»ˆç‚¹)

**ç›®æ ‡ç‚¹æ•°**ï¼š3

### 1. è®¡ç®—é‡è¦æ€§

* **Idx 0**: é¦–ç‚¹ $\rightarrow$ **MAX**
* **Idx 4**: å°¾ç‚¹ $\rightarrow$ **MAX**
* **Idx 1**: $|10(\text{Idx0}) - 2\times10(\text{Idx1}) + 50(\text{Idx2})| = |10 - 20 + 50| = |40| = $ **40**
* **Idx 2**: $|10(\text{Idx1}) - 2\times50(\text{Idx2}) + 10(\text{Idx3})| = |10 - 100 + 10| = |-80| = $ **80** (
  å¼¯æ›²åº¦æœ€å¤§)
* **Idx 3**: $|50(\text{Idx2}) - 2\times10(\text{Idx3}) + 10(\text{Idx4})| = |50 - 20 + 10| = |40| = $ **40**

### 2. æ’åºç»“æœ

1. **Idx 0** (MAX)
2. **Idx 4** (MAX)
3. **Idx 2** (Score: 80)
4. Idx 1 (Score: 40)
5. Idx 3 (Score: 40)

### 3. ç­›é€‰ Top 3

é€‰ä¸­çš„ç´¢å¼•é›†åˆä¸ºï¼š`{0, 4, 2}`

### 4. é‡ç»„è¾“å‡º

æŒ‰ç´¢å¼•æ’åºåï¼š`0 -> 2 -> 4`
**æœ€ç»ˆç»“æœ**ï¼šä¿ç•™äº†èµ·ç‚¹ã€å³°å€¼ç‚¹ã€ç»ˆç‚¹ã€‚
`[10, 50, 10]`

## ä»£ç å¯¹åº”

```java
// 1. åˆå§‹åŒ–é¦–ç‚¹é‡è¦æ€§ä¸ºæ— ç©·å¤§
importances.add(new PointImportance(0, Double.MAX_VALUE));

// 2. éå†ä¸­é—´ç‚¹è®¡ç®—äºŒé˜¶å·®åˆ†
        for(
int i = 1; i <data.

size() -1;i++){
double prev = data.get(i - 1).getY().doubleValue();
double curr = data.get(i).getY().doubleValue();
double next = data.get(i + 1).getY().doubleValue();
// å¯¹åº”å…¬å¼ |next - 2*curr + prev|
    importances.

add(new PointImportance(i, Math.abs(next-2*curr+prev)));
        }

// 3. åˆå§‹åŒ–å°¾ç‚¹é‡è¦æ€§ä¸ºæ— ç©·å¤§
        importances.

add(new PointImportance(data.size() -1,Double.MAX_VALUE));

// 4. æŒ‰é‡è¦æ€§å€’åºæ’åº
        importances.

sort((a, b) ->Double.

compare(b.importance, a.importance));

// 5. å–å‰ targetCount ä¸ªç‚¹çš„ç´¢å¼•
Set<Integer> selectedIndices = new HashSet<>();
for(
int i = 0; i <Math.

min(targetCount, importances.size());i++){
        selectedIndices.

add(importances.get(i).index);
        }

// 6. æŒ‰åŸå§‹ç´¢å¼•é¡ºåºé‡ç»„æ•°æ®
List<Integer> sortedIndices = new ArrayList<>(selectedIndices);
Collections.

sort(sortedIndices);
```

## é€‚ç”¨åœºæ™¯

è¿™ç§æ–¹æ³•éå¸¸é€‚åˆ **Stepï¼ˆé˜¶è·ƒï¼‰** æˆ– **Pulseï¼ˆè„‰å†²ï¼‰** ç±»å‹çš„ä¿¡å·ï¼Œå› ä¸ºå®ƒèƒ½æå…¶ç²¾å‡†åœ°æŠ“ä½ä¿¡å·å‘ç”Ÿçªå˜çš„å…³é”®ä½ç½®ï¼Œè€Œä¸ä¼šåƒæ™®é€šå‡åŒ€é‡‡æ ·é‚£æ ·å¯èƒ½â€œæ¼æ‰â€å°–å³°ã€‚
