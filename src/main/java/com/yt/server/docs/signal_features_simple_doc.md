# SignalFeatures 19个参数计算全过程详解

根据 `AdaptiveDownsamplingSelector` 类中的代码逻辑，对输入序列进行详细推演。

## 原始输入数据

- **y (数据值)**: `[1, 2, 3, 10, 11]`
- **x (索引值)**: `[0, 1, 2, 3, 4]`
- **数据量 n**: `5`

---

## 1. mean (均值)

- **代码位置**: `features.mean = sum / n;`
- **计算过程**:
  1. `sum = 1 + 2 + 3 + 10 + 11 = 27`
  2. `mean = 27 / 5 = 5.4`
- **结果**: `5.4`

## 2. stdDev (标准差)

- **代码位置**: `Math.sqrt(Math.max(0, sumSquare / n - mean * mean))`
- **计算过程**:
  1. `sumSquare = 1² + 2² + 3² + 10² + 11² = 1 + 4 + 9 + 100 + 121 = 235`
  2. `sumSquare / n = 235 / 5 = 47.0`
  3. `mean² = 5.4 * 5.4 = 29.16`
  4. `stdDev = √(47.0 - 29.16) = √17.84 ≈ 4.2237`
- **结果**: `4.2237`

## 3. range (极差)

- **代码位置**: `features.range = max - min;`
- **计算过程**:
  1. `max = 11`, `min = 1`
  2. `range = 11 - 1 = 10`
- **结果**: `10.0`

## 4. volatility (绝对路径波动率)

- **代码位置**: `totalDistance / range`
- **计算过程**:
  1. `totalDistance = |2-1| + |3-2| + |10-3| + |11-10| = 1 + 1 + 7 + 1 = 10`
  2. `volatility = 10 / 10 = 1.0`
- **结果**: `1.0`

## 5. normalizedVolatility (归一化波动率)

- **代码位置**: `calculateNormalizedVolatility(trendInfo.residuals)`
- **计算过程**:
  - 先基于 `residuals (残差)` 序列进行计算。
  - **残差序列**: `[1.2, -0.6, -2.4, 1.8, 0]`（拟合方程见下文 trendSlope）
  - 对残差进行相邻点归一化变化计算 `|y1-y0| / avg`：
    1. `|(-0.6)-1.2| / (|1.2|+|-0.6|)/2 = 1.8 / 0.9 = 2.0`
    2. `|(-2.4)-(-0.6)| / (|-0.6|+|-2.4|)/2 = 1.8 / 1.5 = 1.2`
    3. `|1.8-(-2.4)| / (|-2.4|+|1.8|)/2 = 4.2 / 2.1 = 2.0`
    4. `|0-1.8| / (|1.8|+|0|)/2 = 1.8 / 0.9 = 2.0`
  - 平均值: `(2.0 + 1.2 + 2.0 + 2.0) / 4 = 1.8`
- **结果**: `1.8`

## 6. flatness (平坦度)

- **代码位置**: `features.stdDev / features.range`
- **计算过程**:
  1. `4.2237 / 10.0 = 0.42237`
- **结果**: `0.42237`

## 7. linearity (线性度/R²)

- **代码位置**: `1 - (ssRes / ssTot)`
- **计算过程**:
  1. `meanY = 5.4`
  2. `ssTot = (1-5.4)² + (2-5.4)² + (3-5.4)² + (10-5.4)² + (11-5.4)² = 19.36+11.56+5.76+21.16+31.36 = 89.2`
  3. 使用线性拟合 `y = 2.8x - 0.2` (拟合过程见参数11)
  4.
  `ssRes = (1 - (-0.2))² + (2-2.6)² + (3-5.4)² + (10-8.2)² + (11-11)² = 1.2² + (-0.6)² + (-2.4)² + 1.8² + 0² = 1.44+0.36+5.76+3.24+0 = 10.8`
  5. `R² = 1 - (10.8 / 89.2) = 1 - 0.121 = 0.879`
- **结果**: `0.879`

## 8. periodicity (周期性强度)

- **代码位置**: `detectPeriodicity(trendInfo.residuals)`
- **计算过程**:
  - 代码中有硬检查: `if (values.size() < 10) return 0.0;`
  - 因为当前样本数 `n=5` 小于 10。
- **结果**: `0.0`

## 9. autocorrelation (自相关系数)

- **代码位置**: `calculateAutocorrelation(data, Math.max(1, n / 4))`
- **计算过程**:
  1. `lag = max(1, 5/4) = 1`
  2. `numerator = ∑(y_i - mean)(y_{i+1} - mean)`

  - `(1-5.4)(2-5.4) = (-4.4)(-3.4) = 14.96`
  - `(2-5.4)(3-5.4) = (-3.4)(-2.4) = 8.16`
  - `(3-5.4)(10-5.4) = (-2.4)(4.6) = -11.04`
  - `(10-5.4)(11-5.4) = (4.6)(5.6) = 25.76`
  - `sum_num = 14.96 + 8.16 - 11.04 + 25.76 = 37.84`

  3. `denominator = ∑(y_i - mean)² = 89.2` (即 ssTot)
  4. `autocorrelation = 37.84 / 89.2 ≈ 0.4242`
- **结果**: `0.4242`

## 10. stepCount (阶跃次数)

- **代码位置**: `detectSteps(data)`，基于 `mean + 3*stdDev` 的导数统计。
- **计算过程**:
  1. `derivatives (一阶导数序列) = [1, 1, 7, 1]`
  2. `mean_d = (1+1+7+1)/4 = 2.5`
  3. `sumSq_d = 1²+1²+7²+1² = 1+1+49+1 = 52`
  4. `stdDev_d = √(52/4 - 2.5²) = √(13 - 6.25) = √6.75 ≈ 2.598`
  5. `threshold = 2.5 + 3 * 2.598 = 10.294`
  6. 检查 `[1, 1, 7, 1]` 中是否有值超过 `10.294`。
  7. 全部未超过。
- **结果**: `0`

## 11. trendSlope (趋势斜率)

- **代码位置**: `(n * sumXY - sumX * sumY) / denominator`
- **计算过程**:
  1. `sumX = 0+1+2+3+4 = 10`
  2. `sumY = 1+2+3+10+11 = 27`
  3. `sumXY = 0*1 + 1*2 + 2*3 + 3*10 + 4*11 = 0+2+6+30+44 = 82`
  4. `sumX² = 0+1+4+9+16 = 30`
  5. `denominator = 5*30 - 10*10 = 150 - 100 = 50`
  6. `slope = (5*82 - 10*27) / 50 = (410 - 270) / 50 = 140 / 50 = 2.8`
- **结果**: `2.8` (截距 `intercept = (27 - 2.8*10)/5 = -0.2`)

## 12. noiseRatio (噪声占比)

- **代码位置**: `smoothChange / totalChange` (二阶导 / 总变化)
- **计算过程**:
  1. `smoothChange = |3 - 2*2 + 1| + |10 - 2*3 + 2| + |11 - 2*10 + 3| = |0| + |6| + |-6| = 12`
  2. `totalChange = |3 - 1| + |10 - 2| + |11 - 3| = 2 + 8 + 8 = 18`
  3. `noiseRatio = 12 / 18 = 0.6667`
- **结果**: `0.6667`

## 13. zeroCrossings (过零率)

- **代码位置**: `countZeroCrossings(data, features.mean)`
- **计算过程**:
  1. `mean = 5.4`
  2. 符号序列 (y > 5.4 为 +，否则为 -)：`[-, -, -, +, +]`
  3. 变化点：在 `3` (-) 到 `10` (+) 处发生了一次符号改变。
- **结果**: `1`

## 14. maxAbsDerivative (最大瞬时变化率)

- **代码位置**: `Math.max(max, diff)`
- **计算过程**:
  1. `diffs = [1, 1, 7, 1]`
  2. `max = 7.0`
- **结果**: `7.0`

## 15. estimatedPeriod (预估周期)

- **限制**: 同样受限于 `n < 10` 的硬检查。
- **结果**: `0.0`

## 16. residualStdDev (残差标准差)

- **代码位置**: `info.residualStdDev`
- **计算过程**:
  1. `ssRes = 10.8` (见参数7)
  2. `meanR = 0` (最小二乘法残差均值为0)
  3. `stdDev = √(10.8 / 5 - 0) = √2.16 ≈ 1.4697`
- **结果**: `1.4697`

## 17. detrendedRange (去趋势极差)

- **代码位置**: `info.residualRange` (残差的最大值 - 最小值)
- **计算过程**:
  1. `residuals = [1.2, -0.6, -2.4, 1.8, 0]`
  2. `maxR = 1.8`, `minR = -2.4`
  3. `1.8 - (-2.4) = 4.2`
- **结果**: `4.2`

## 18. trendStrength (趋势强度)

- **代码位置**: `Math.min(1.0, Math.abs(slope) * n / (range + 1e-6))`
- **计算过程**:
  1. `|2.8| * 5 / 10 = 14 / 10 = 1.4`
  2. `Math.min(1.0, 1.4) = 1.0`
- **结果**: `1.0`

## 19. envelopeGrowthRatio (包络增长比)

- **代码位置**: `Math.min(10.0, range / (residualRange + 1e-6))`
- **计算过程**:
  1. `10.0 / 4.2 ≈ 2.381`
- **结果**: `2.381`

---

## 总结

`SignalFeatures` 的这 19 个参数构成了一个多维度的“信号指纹”：

1. **基础统计层 (1-3, 6)**：通过均值、标准差和极差，勾勒出信号的宏观范围和基本分布。
2. **趋势与几何层 (7, 11, 18)**：识别信号是否存在明显的线性偏移（如持续上升或下降），这是决定是否需要“去趋势”处理的关键。
3. **波动与噪声层 (4, 5, 10, 12, 14, 16)**：通过对原数据及其残差的细微变化分析，区分是高频随机噪声（Noise）还是具有物理意义的剧烈跳变（Step/Pulse）。
4. **结构特征层 (8, 9, 13, 15, 17, 19)**：捕捉信号内部的自相关性、周期性以及包络形态，帮助算法在极高压缩比下依然能精准保留波峰、波谷等关键特征。

这种全方位的特征画像，使得 `AdaptiveDownsamplingSelector` 能够不再依赖单一的降采样算法，而是根据当前的信号“性格”，在
LTTB、MinMax、包络保护等多种专业算法间实现最优切换。

---

## 示例数据结果汇总 (y=[1, 2, 3, 10, 11])

| 编号 | 参数名称                     | 计算结果    | 特征含义                |
|:---|:-------------------------|:--------|:--------------------|
| 1  | **mean**                 | 5.4     | 信号基准水平              |
| 2  | **stdDev**               | 4.2237  | 总波动强度               |
| 3  | **range**                | 10.0    | 垂直总跨度               |
| 4  | **volatility**           | 1.0     | 路径绝对复杂度             |
| 5  | **normalizedVolatility** | 1.8     | 去趋势后的高频噪声程度         |
| 6  | **flatness**             | 0.42237 | 波动相对剧烈度             |
| 7  | **linearity**            | 0.879   | 信号的线性拟合质量 (R²)      |
| 8  | **periodicity**          | 0.0     | 信号是否存在周期规律 (n < 10) |
| 9  | **autocorrelation**      | 0.4242  | 信号前后的关联相关性          |
| 10 | **stepCount**            | 0       | 满足 3-sigma 统计的阶跃点数  |
| 11 | **trendSlope**           | 2.8     | 总体线性演进斜率            |
| 12 | **noiseRatio**           | 0.6667  | 抖动分量占总变化的比例         |
| 13 | **zeroCrossings**        | 1       | 信号跨越均值的频繁度          |
| 14 | **maxAbsDerivative**     | 7.0     | 最大瞬间变化强度            |
| 15 | **estimatedPeriod**      | 0.0     | 识别出的物理频率/周期         |
| 16 | **residualStdDev**       | 1.4697  | 偏离线性趋势的偏差水平         |
| 17 | **detrendedRange**       | 4.2     | 去除趋势后的纯波动幅度         |
| 18 | **trendStrength**        | 1.0     | 趋势成分对总波动的占比         |
| 19 | **envelopeGrowthRatio**  | 2.381   | 信号包络的扩张厚度比          |

