# 工业级自适应降采样算法设计文档 (v4.0)

## 1. 核心概述

`AdaptiveDownsamplingSelector` 是一套基于**信号特征识别**与**动态资源分配**的混合降采样引擎。与传统单一算法（如单纯的 LTTB
或 Min-Max）不同，它能够识别信号的数学特征，并根据压缩倍率动态切换最优的处理策略，确保“**微观形状不失真，宏观包络不丢失**”。

## 2. 算法流水线 (Pipeline)

算法执行分为五个核心阶段：

1. **全局评估**：计算总点数与目标点数的压缩比（Compression Ratio）。
2. **分块分析**：根据压缩比动态调整窗口大小（Adaptive Window），并提取各窗口的数学特征。
3. **资源配额分配**：根据窗口的“信息熵”（复杂度）分配采样点数，并执行最小密度保护。
4. **算法匹配执行**：为每个窗口匹配最适合的降采样算法。
5. **结果归一化**：通过补点（Gap Filling）或裁剪，确保输出点数精确等于预期。

## 3. 信号特征提取 (Feature Extraction)

系统通过 `SignalFeatures` 结构体捕捉信号的深度指纹：

* **波动性 (Volatility)**：归一化的一阶差分均值，衡量信号的活跃程度，对振幅不敏感。
* **线性度 (Linearity)**：基于 R² 拟合优度，判断信号是否趋于直线。
* **周期性 (Periodicity)**：利用自相关函数检测重复模式及其周期长度。
* **突变检测 (Step/Pulse)**：通过一阶导数识别阶跃和脉冲。
* **包络特征 (Envelope Growth)**：专门识别调幅信号（如振幅线性增长的正弦波）。

## 4. 动态资源分配策略 (Weighting & Allocation)

这是算法解决“波形稀疏”的关键。

### 4.1 权重计算公式

每个窗口的权重 $W$ 由多维度累加而成：
$$W = \text{Base}(0.3) + \text{Volatility} \times 1.2 + \text{ComplexityBonus} + \text{SpikeBonus} + \text{PeriodicityBonus}$$

* **劫富济贫**：复杂的震荡区域（高 $W$）会从平坦区域（低 $W$）“夺取”更多的采样点数配额。

### 4.2 安全保底约束

* **最小密度保护**：每个窗口强制保留至少 2% 的原始点，防止长周期查询时出现视觉断层。
* **稀疏度控制**：窗口最大稀疏度限制在 50% 以内。

## 5. 算法库与决策逻辑

### 5.1 七大核心算法

1. **KEEP_FIRST_LAST**：用于 `FLAT` 信号，极致压缩。
2. **LTTB**：中低压缩比下的首选，保持最佳几何视觉形态。
3. **MIN_MAX**：高压缩比下的噪声处理，保证峰值可见。
4. **UNIFORM**：等距采样，作为基础填充。
5. **PEAK_DETECTION**：用于阶跃和脉冲，锁定物理拐点。
6. **ADAPTIVE_LTTB**：复杂组合信号的二次加权处理。
7. **HYBRID_ENVELOPE (v4.0 核心)**：
    * **40% 极值**：勾勒上下包络。
    * **30% 中心带**：采样均值点，防止中间掏空。
    * **30% 形状点**：填充细节。

### 5.2 决策矩阵

* **高压缩比 (> 10x)**：优先进入“包络保护模式”，周期信号强制使用 `HYBRID_ENVELOPE`。
* **低压缩比 (< 10x)**：优先进入“形状优先模式”，侧重 `LTTB` 展现曲线美感。

## 6. 结果精准化 (Normalization)

为了满足前端图表控件对点数的精确要求，算法最后执行：

* **智能补点 (Fill Gaps)**：识别时间轴上最大的时间空隙（Gap），从原始数据中递归提取点进行填充。
* **等距裁剪 (Uniform Trim)**：如果点数超出，利用步长算法进行无偏裁剪。

## 7. 典型应用场景表现

* **调幅正弦波 (r0)**：在长达数小时的全局视图下，`HYBRID_ENVELOPE` 确保波形呈现为实心的包络带，无条纹和稀疏感。
* **阶跃信号**：`PEAK_DETECTION` 确保开关跳变的瞬间点被 100% 保留。
* **静态信号 (r1, r2)**：几乎不占用采样配额，将资源全部留给动态变量。

---
**版本说明**：v4.0 重点强化了在大规模数据集下的分布均匀性和补点逻辑的健壮性。
