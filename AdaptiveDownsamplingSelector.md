# 工业级自适应降采样算法设计文档 (v5.0)

## 1. 核心概述

`AdaptiveDownsamplingSelector` 是一套基于**信号特征识别**与**动态资源分配**的混合降采样引擎。与传统单一算法（如单纯的 LTTB
或 Min-Max）不同，它能够识别信号的数学特征，并根据压缩倍率动态切换最优的处理策略，确保“**微观形状不失真，宏观包络不丢失**”。

## 2. 算法流水线 (Pipeline)

算法执行分为五个核心阶段：

1. **全局评估**：计算总点数与目标点数的压缩比（Compression Ratio）。
2. **分块分析**：根据压缩比动态调整窗口大小（Adaptive Window），并提取各窗口的数学特征。
3. **资源配额分配**：根据窗口的“信息熵”（复杂度）分配采样点数，并执行最小密度保护。
4. **算法匹配执行**：为每个窗口匹配最适合的降采样算法。
5. **结果归一化**：通过补点（Gap Filling, v5.0 改用中点优先策略）或裁剪，确保输出点数精确等于预期。

## 3. 信号特征提取 (Feature Extraction)

系统通过 `SignalFeatures` 结构体捕捉信号的深度指纹：

* **波动性 (Volatility)**：归一化的一阶差分均值，衡量信号的活跃程度，对振幅不敏感。
* **线性度 (Linearity)**：基于 R² 拟合优度，判断信号是否趋于直线。
* **周期性 (Periodicity)**：利用自相关函数检测重复模式及其周期长度。
* **突变检测 (Step/Pulse)**：通过一阶导数识别阶跃和脉冲。
* **包络特征 (Envelope Growth)**：专门识别调幅信号（如振幅线性增长的正弦波）。

### 3.1 信号特征字段详解 (SignalFeatures)

系统通过以下指标为信号进行“画像”：

| 字段                       | 名称     | 详细说明                                        |
|:-------------------------|:-------|:--------------------------------------------|
| **mean**                 | 均值     | 数据点的平均值，用于确定信号的基准线（Baseline）。               |
| **stdDev**               | 标准差    | 衡量数据的离散程度。值越大，说明信号相对于基准线的波动越剧烈。             |
| **range**                | 值域     | 数据集的极差（Max - Min），反映信号覆盖的物理跨度。              |
| **volatility**           | 绝对波动率  | 计算为“总行程 / 值域”，衡量信号在垂直方向上的累计变动量。             |
| **normalizedVolatility** | 归一化波动率 | **核心指标**。衡量相邻点变化的百分比。它对振幅不敏感，是判断信号活跃度的重要标准。 |
| **flatness**             | 平坦度    | 标准差与值域的比值。值极小时，说明信号几乎是一条平滑的直线。              |
| **linearity**            | 线性度    | 基于 R²（拟合优度）计算，值越接近 1.0 说明信号越趋于线性增长或减少。      |
| **trendSlope**           | 趋势斜率   | 通过线性回归计算出的斜率，反映信号整体的宏观上升或下降趋势。              |
| **periodicity**          | 周期性强度  | 通过自相关函数计算，值越高说明信号具有越明显的重复规律（如正弦波）。          |
| **autocorrelation**      | 自相关系数  | 衡量信号与其自身在一定延迟后的相似度，辅助判断信号的自相关特性。            |
| **stepCount**            | 阶跃次数   | 检测信号中突然大幅跳变的频率，用于识别开关量信号或阶跃响应。              |
| **noiseRatio**           | 噪声比    | 通过分析二阶导数（加速度）来衡量高频随机波动的占比，用于识别信号纯净度。        |

## 4. 信号分类 (SignalType)

系统根据提取的特征，将输入信号划分为以下 9 种类型，作为算法选择的基础：

| 信号类型                    | 名称     | 判定逻辑 / 特征说明                | 典型场景         |
|:------------------------|:-------|:---------------------------|:-------------|
| **FLAT**                | 平坦信号   | 平坦度（flatness）低。            | 传感器待机、零位信号。  |
| **LINEAR**              | 线性信号   | 线性度（linearity）高且噪声比低。      | 匀速升温、匀速位移。   |
| **PERIODIC**            | 周期信号   | 周期性强度（periodicity）高。       | 标准正弦波、转速信号。  |
| **AMPLITUDE_MODULATED** | 调幅周期信号 | 具有明显周期性，且振幅随时间呈增长趋势。       | 电机启动、震荡发散过程。 |
| **STEP**                | 阶跃信号   | 检测到显著的瞬时跳变。                | 开关合闸、负载突变。   |
| **PULSE**               | 脉冲信号   | 短时间内出现数次高频波动且波动率大。         | 尖峰干扰、电火花。    |
| **NOISE**               | 高噪声信号  | 波动率极高且噪声比超过阈值。             | 传感器干扰、气流扰动。  |
| **TREND_NOISE**         | 带趋势噪声  | 具有宏观斜率（trendSlope）且伴随高频噪声。 | 带负载运行中的震动。   |
| **COMPLEX**             | 复杂信号   | 不符合上述单一特征的组合信号。            | 多种信号叠加的原始信号。 |

## 5. 动态资源分配策略 (Weighting & Allocation)

这是算法解决“波形稀疏”的关键。

### 4.1 权重计算公式

每个窗口的权重 $W$ 由多维度累加而成：
$$W = \text{Base}(0.3) + \text{Volatility} \times 1.2 + \text{ComplexityBonus} + \text{SpikeBonus} + \text{PeriodicityBonus}$$

* **劫富济贫**：复杂的震荡区域（高 $W$）会从平坦区域（低 $W$）“夺取”更多的采样点数配额。

### 4.2 安全保底约束

* **最小密度保护**：每个窗口强制保留至少 2% 的原始点，防止长周期查询时出现视觉断层。
* **稀疏度控制**：窗口最大稀疏度限制在 50% 以内。

## 6. 算法库与决策逻辑

### 6.1 八大核心算法

1. **KEEP_FIRST_LAST**：用于 `FLAT` 信号，极致压缩。
2. **LTTB**：中低压缩比下的首选，保持最佳几何视觉形态。
3. **MIN_MAX**：高压缩比下的噪声处理，保证峰值可见。
4. **UNIFORM**：等距采样，作为基础填充。
5. **PEAK_DETECTION**：用于阶跃和脉冲，锁定物理拐点。
6. **ADAPTIVE_LTTB**：复杂组合信号的二次加权处理。
7. **HYBRID_ENVELOPE (v4.0 核心)**：
    * **40% 极值**：勾勒上下包络。
    * **30% 中心带**：采样均值点，防止中间掏空。
    * **30% 形状点**：填充细节。
8. **UNIFORM_WITH_EXTREMES (v5.0 核心)**：
   * **极值保护**：强制保留全局 Max/Min 及局部显著极值点（约 15% 配额）。
   * **均匀采样**：在剩余空间执行均匀步长采样，解决噪声数据聚集问题。

### 5.2 决策矩阵

* **高压缩比 (> 10x)**：优先进入“包络保护模式”，周期信号强制使用 `HYBRID_ENVELOPE`，高噪声/复杂信号强制使用
  `UNIFORM_WITH_EXTREMES`。
* **低压缩比 (< 10x)**：优先进入“形状优先模式”，对于 `NOISE` 类型使用 `UNIFORM_WITH_EXTREMES` 以确保分布均匀。

## 7. 结果精准化 (Normalization)

为了满足前端图表控件对点数的精确要求，算法最后执行：

* **智能补点 (Fill Gaps, v5.0)**：识别时间轴上最大的时间空隙（Gap），**优先选择中点位置的点**，并支持大 Gap 的 1/4、3/4 处均匀补点。
* **等距裁剪 (Uniform Trim)**：如果点数超出，利用步长算法进行无偏裁剪。

## 8. 典型应用场景表现

* **调幅正弦波 (r0)**：在长达数小时的全局视图下，`HYBRID_ENVELOPE` 确保波形呈现为实心的包络带，无条纹和稀疏感。
* **阶跃信号**：`PEAK_DETECTION` 确保开关跳变的瞬间点被 100% 保留。
* **静态信号 (r1, r2)**：几乎不占用采样配额，将资源全部留给动态变量。

---
**版本说明**：v5.0 重点引入了 `UNIFORM_WITH_EXTREMES` 算法，解决了高波动/噪声数据在极端压缩情况下的视觉聚集与极值丢失问题。
